<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Lab Monitoring Dashboard - Real-Time Status</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .status-banner {
            background: #4CAF50;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .status-banner.error {
            background: #f44336;
            animation: blink 1s infinite;
        }
        .status-banner.warning {
            background: #ff9800;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #ffd700;
            font-size: 1.5em;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px 0;
            font-size: 0.9em;
        }
        .status.running {
            background: #4CAF50;
            color: white;
        }
        .status.stopped {
            background: #f44336;
            color: white;
        }
        .status.warning {
            background: #ff9800;
            color: white;
        }
        .status.unknown {
            background: #9e9e9e;
            color: white;
        }
        .service-list {
            list-style: none;
            padding: 0;
        }
        .service-list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .service-list li:last-child {
            border-bottom: none;
        }
        .service-name {
            font-weight: bold;
        }
        .service-url {
            color: #87CEEB;
            text-decoration: none;
            font-size: 0.9em;
        }
        .service-url:hover {
            text-decoration: underline;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.7;
        }
        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
        }
        .refresh-btn:hover {
            background: #45a049;
        }
        .alert-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
        }
        .alert-btn:hover {
            background: #d32f2f;
        }
        .log-container {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-entry.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        .log-entry.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        .log-entry.warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        .log-entry.info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Lab Monitoring Dashboard</h1>
            <p>Real-Time Production Monitoring for Ansible Baseline, FIM, and CMDB Lab</p>
            <div id="status-banner" class="status-banner">
                üîÑ Initializing monitoring...
            </div>
            <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh All</button>
            <button class="alert-btn" onclick="testAllConnections()">üö® Test All</button>
            <button class="refresh-btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>

        <div class="dashboard-grid">
            <!-- Critical Services Status -->
            <div class="card">
                <h3>üö® Critical Services</h3>
                <ul class="service-list">
                    <li>
                        <span class="service-name">Grafana Dashboard</span>
                        <div>
                            <span class="status unknown" id="grafana-status">CHECKING...</span>
                            <a href="http://localhost:3000" class="service-url" target="_blank">localhost:3000</a>
                        </div>
                    </li>
                    <li>
                        <span class="service-name">Prometheus Server</span>
                        <div>
                            <span class="status unknown" id="prometheus-status">CHECKING...</span>
                            <a href="http://localhost:9090" class="service-url" target="_blank">localhost:9090</a>
                        </div>
                    </li>
                    <li>
                        <span class="service-name">SSH Tunnels</span>
                        <div>
                            <span class="status unknown" id="ssh-tunnels-status">CHECKING...</span>
                            <span class="service-url">9 tunnels</span>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- AWS Infrastructure -->
            <div class="card">
                <h3>‚òÅÔ∏è AWS Infrastructure</h3>
                <ul class="service-list">
                    <li>
                        <span class="service-name">Node Exporters</span>
                        <div>
                            <span class="status unknown" id="node-exporters-status">CHECKING...</span>
                            <span class="service-url">3 instances</span>
                        </div>
                    </li>
                    <li>
                        <span class="service-name">FIM Agents</span>
                        <div>
                            <span class="status unknown" id="fim-agents-status">CHECKING...</span>
                            <span class="service-url">3 instances</span>
                        </div>
                    </li>
                    <li>
                        <span class="service-name">CMDB Collectors</span>
                        <div>
                            <span class="status unknown" id="cmdb-collectors-status">CHECKING...</span>
                            <span class="service-url">3 instances</span>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Live Metrics -->
            <div class="card">
                <h3>üìä Live Metrics</h3>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="prometheus-targets">-</div>
                        <div class="metric-label">Prometheus Targets</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="fim-events">-</div>
                        <div class="metric-label">FIM Events</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="cmdb-collections">-</div>
                        <div class="metric-label">CMDB Collections</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="uptime">-</div>
                        <div class="metric-label">Uptime (min)</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h3>‚ö° Quick Actions</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <a href="http://localhost:3000" target="_blank" class="service-url" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; text-align: center;">
                        üìä Open Grafana Dashboard
                    </a>
                    <a href="http://localhost:9090" target="_blank" class="service-url" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; text-align: center;">
                        üîç Open Prometheus
                    </a>
                    <a href="http://localhost:9090/targets" target="_blank" class="service-url" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; text-align: center;">
                        üéØ Check Prometheus Targets
                    </a>
                    <button class="refresh-btn" onclick="startTunnels()">üöÄ Start SSH Tunnels</button>
                </div>
            </div>
        </div>

        <!-- Real-Time Log -->
        <div class="card">
            <h3>üìã Real-Time Monitoring Log</h3>
            <div id="log-container" class="log-container">
                <div class="log-entry info">üöÄ Dashboard initialized - Starting monitoring...</div>
            </div>
        </div>

        <!-- AWS Instances Detail -->
        <div class="card">
            <h3>‚òÅÔ∏è AWS Instances Detail</h3>
            <div class="dashboard-grid">
                <div class="card">
                    <h4>üñ•Ô∏è manage-node-1 (Amazon Linux)</h4>
                    <p><strong>IP:</strong> 18.234.152.228</p>
                    <p><strong>Node Exporter:</strong> <span class="status unknown" id="node1-status">CHECKING...</span></p>
                    <p><strong>FIM Agent:</strong> <span class="status unknown" id="fim1-status">CHECKING...</span></p>
                    <p><strong>CMDB Collector:</strong> <span class="status unknown" id="cmdb1-status">CHECKING...</span></p>
                    <p><strong>Metrics:</strong> <a href="http://localhost:9101/metrics" target="_blank" class="service-url">View Raw</a></p>
                </div>
                <div class="card">
                    <h4>üñ•Ô∏è manage-node-2 (Ubuntu)</h4>
                    <p><strong>IP:</strong> 54.242.234.69</p>
                    <p><strong>Node Exporter:</strong> <span class="status unknown" id="node2-status">CHECKING...</span></p>
                    <p><strong>FIM Agent:</strong> <span class="status unknown" id="fim2-status">CHECKING...</span></p>
                    <p><strong>CMDB Collector:</strong> <span class="status unknown" id="cmdb2-status">CHECKING...</span></p>
                    <p><strong>Metrics:</strong> <a href="http://localhost:9102/metrics" target="_blank" class="service-url">View Raw</a></p>
                </div>
                <div class="card">
                    <h4>üñ•Ô∏è manage-node-3 (Ubuntu)</h4>
                    <p><strong>IP:</strong> 13.217.82.23</p>
                    <p><strong>Node Exporter:</strong> <span class="status unknown" id="node3-status">CHECKING...</span></p>
                    <p><strong>FIM Agent:</strong> <span class="status unknown" id="fim3-status">CHECKING...</span></p>
                    <p><strong>CMDB Collector:</strong> <span class="status unknown" id="cmdb3-status">CHECKING...</span></p>
                    <p><strong>Metrics:</strong> <a href="http://localhost:9103/metrics" target="_blank" class="service-url">View Raw</a></p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üéØ Production-Grade Lab Environment | Real-Time Monitoring Active</p>
            <p>Last Updated: <span id="last-updated"></span> | Auto-refresh: <span id="refresh-countdown">30</span>s</p>
        </div>
    </div>

    <script>
        let refreshInterval;
        let countdownInterval;
        let refreshCountdown = 30;
        let startTime = Date.now();

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            log('Logs cleared', 'info');
        }

        function updateTimestamp() {
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        function updateCountdown() {
            document.getElementById('refresh-countdown').textContent = refreshCountdown;
            if (refreshCountdown <= 0) {
                refreshCountdown = 30;
            } else {
                refreshCountdown--;
            }
        }

        function updateStatusBanner(overallStatus) {
            const banner = document.getElementById('status-banner');
            if (overallStatus === 'healthy') {
                banner.textContent = '‚úÖ All systems operational - Monitoring active';
                banner.className = 'status-banner';
            } else if (overallStatus === 'warning') {
                banner.textContent = '‚ö†Ô∏è Some services have issues - Check logs';
                banner.className = 'status-banner warning';
            } else {
                banner.textContent = 'üö® Critical services down - Immediate attention required';
                banner.className = 'status-banner error';
            }
        }

        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = `status ${status.toLowerCase()}`;
            if (message) {
                log(`${elementId}: ${message}`, status === 'running' ? 'success' : 'error');
            }
        }

        async function testEndpoint(url, timeout = 5000) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(url, {
                    method: 'GET',
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                // Accept 200 (OK), 302 (redirect), 401 (unauthorized but service is up), 405 (method not allowed but service is up)
                return response.ok || response.status === 302 || response.status === 401 || response.status === 405;
            } catch (error) {
                console.log(`Endpoint ${url} failed:`, error.message);
                return false;
            }
        }

        async function testGrafana() {
            const isUp = await testEndpoint('http://localhost:3000/api/health');
            updateStatus('grafana-status', isUp ? 'running' : 'stopped', 
                isUp ? 'Grafana is responding' : 'Grafana is not responding');
            return isUp;
        }

        async function testPrometheus() {
            const isUp = await testEndpoint('http://localhost:9090/api/v1/status/config');
            updateStatus('prometheus-status', isUp ? 'running' : 'stopped',
                isUp ? 'Prometheus is responding' : 'Prometheus is not responding');
            return isUp;
        }

        async function testSSHTunnels() {
            const ports = [9101, 9102, 9103, 8080, 8081, 8082, 8083, 8084, 8085];
            let activeCount = 0;
            
            // Test all ports in parallel for better performance
            const promises = ports.map(async (port) => {
                try {
                    const response = await fetch(`http://localhost:${port}/metrics`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        signal: AbortSignal.timeout(3000) // 3 second timeout
                    });
                    return response.ok;
                } catch (error) {
                    return false;
                }
            });
            
            const results = await Promise.allSettled(promises);
            activeCount = results.filter(r => r.status === 'fulfilled' && r.value === true).length;
            
            const status = activeCount === 9 ? 'running' : (activeCount > 0 ? 'warning' : 'stopped');
            updateStatus('ssh-tunnels-status', status, 
                `${activeCount}/9 tunnels active`);
            return activeCount === 9;
        }

        async function testNodeExporters() {
            const ports = [9101, 9102, 9103];
            let activeCount = 0;
            
            // Test all ports in parallel for better performance
            const promises = ports.map(async (port, index) => {
                try {
                    const response = await fetch(`http://localhost:${port}/metrics`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        signal: AbortSignal.timeout(3000) // 3 second timeout
                    });
                    const isUp = response.ok;
                    updateStatus(`node${index+1}-status`, isUp ? 'running' : 'stopped');
                    return isUp;
                } catch (error) {
                    updateStatus(`node${index+1}-status`, 'stopped');
                    return false;
                }
            });
            
            const results = await Promise.allSettled(promises);
            activeCount = results.filter(r => r.status === 'fulfilled' && r.value === true).length;
            
            const status = activeCount === 3 ? 'running' : (activeCount > 0 ? 'warning' : 'stopped');
            updateStatus('node-exporters-status', status, 
                `${activeCount}/3 Node Exporters active`);
            return activeCount === 3;
        }

        async function testFIMAgents() {
            const ports = [8080, 8082, 8084];
            let activeCount = 0;
            
            for (let i = 0; i < ports.length; i++) {
                const port = ports[i];
                const isUp = await testEndpoint(`http://localhost:${port}/metrics`);
                updateStatus(`fim${i+1}-status`, isUp ? 'running' : 'stopped');
                if (isUp) activeCount++;
            }
            
            const status = activeCount === 3 ? 'running' : (activeCount > 0 ? 'warning' : 'stopped');
            updateStatus('fim-agents-status', status, 
                `${activeCount}/3 FIM Agents active`);
            return activeCount === 3;
        }

        async function testCMDBCollectors() {
            const ports = [8081, 8083, 8085];
            let activeCount = 0;
            
            for (let i = 0; i < ports.length; i++) {
                const port = ports[i];
                const isUp = await testEndpoint(`http://localhost:${port}/metrics`);
                updateStatus(`cmdb${i+1}-status`, isUp ? 'running' : 'stopped');
                if (isUp) activeCount++;
            }
            
            const status = activeCount === 3 ? 'running' : (activeCount > 0 ? 'warning' : 'stopped');
            updateStatus('cmdb-collectors-status', status, 
                `${activeCount}/3 CMDB Collectors active`);
            return activeCount === 3;
        }

        async function testPrometheusQueries() {
            try {
                // Test FIM metrics
                const fimResponse = await fetch('http://localhost:9090/api/v1/query?query=fim_events_total');
                const fimData = await fimResponse.json();
                const fimCount = fimData.data.result ? fimData.data.result.length : 0;
                document.getElementById('fim-events').textContent = fimCount;
                
                // Test CMDB metrics
                const cmdbResponse = await fetch('http://localhost:9090/api/v1/query?query=cmdb_collections_total');
                const cmdbData = await cmdbResponse.json();
                const cmdbCount = cmdbData.data.result ? cmdbData.data.result.length : 0;
                document.getElementById('cmdb-collections').textContent = cmdbCount;
                
                // Test targets
                const targetsResponse = await fetch('http://localhost:9090/api/v1/targets');
                const targetsData = await targetsResponse.json();
                const targetCount = targetsData.data.activeTargets ? targetsData.data.activeTargets.length : 0;
                document.getElementById('prometheus-targets').textContent = targetCount;
                
                log(`Prometheus queries: ${fimCount} FIM events, ${cmdbCount} CMDB collections, ${targetCount} targets`, 'success');
                return true;
            } catch (error) {
                log(`Prometheus queries failed: ${error.message}`, 'error');
                document.getElementById('fim-events').textContent = 'ERROR';
                document.getElementById('cmdb-collections').textContent = 'ERROR';
                document.getElementById('prometheus-targets').textContent = 'ERROR';
                return false;
            }
        }

        function updateUptime() {
            const uptimeMs = Date.now() - startTime;
            const uptimeMinutes = Math.floor(uptimeMs / 60000);
            document.getElementById('uptime').textContent = uptimeMinutes;
        }

        async function refreshAll() {
            log('üîÑ Starting full system check...', 'info');
            updateTimestamp();
            
            const results = await Promise.allSettled([
                testGrafana(),
                testPrometheus(),
                testSSHTunnels(),
                testNodeExporters(),
                testFIMAgents(),
                testCMDBCollectors(),
                testPrometheusQueries()
            ]);
            
            const successCount = results.filter(r => r.status === 'fulfilled' && r.value === true).length;
            const totalTests = results.length;
            
            // Log detailed results for debugging
            log(`üìä System check complete: ${successCount}/${totalTests} systems operational`, 'info');
            
            if (successCount === totalTests) {
                updateStatusBanner('healthy');
                log('‚úÖ All systems operational', 'success');
            } else if (successCount > totalTests / 2) {
                updateStatusBanner('warning');
                log(`‚ö†Ô∏è ${totalTests - successCount} systems have issues`, 'warning');
            } else {
                updateStatusBanner('error');
                log(`üö® ${totalTests - successCount} critical systems down`, 'error');
            }
            
            updateUptime();
        }

        async function testAllConnections() {
            log('üö® Manual connection test initiated...', 'info');
            await refreshAll();
        }

        function startTunnels() {
            log('üöÄ Starting SSH tunnels...', 'info');
            // This would typically call a backend script
            alert('To start SSH tunnels, run: ./manage-tunnels.sh start');
        }

        // Initialize
        function init() {
            log('üöÄ Dashboard initialized', 'info');
            updateTimestamp();
            refreshAll();
            
            // Auto-refresh every 30 seconds
            refreshInterval = setInterval(refreshAll, 30000);
            
            // Update countdown every second
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // Start monitoring
        init();
    </script>
</body>
</html>