#!/bin/bash
# Security check script - Generated by Ansible

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Log file
LOG_FILE="/var/log/security-check.log"

# Logging function
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check function
check_security() {
    local check_name="$1"
    local command="$2"
    local expected="$3"
    
    echo -n "Checking $check_name... "
    
    if eval "$command" >/dev/null 2>&1; then
        echo -e "${GREEN}PASS${NC}"
        log_message "SECURITY CHECK PASS: $check_name"
        return 0
    else
        echo -e "${RED}FAIL${NC}"
        log_message "SECURITY CHECK FAIL: $check_name"
        return 1
    fi
}

echo "=== Security Check Report - $(date) ==="
log_message "Starting security check"

# Check 1: SSH configuration
check_security "SSH Root Login Disabled" "grep -q '^PermitRootLogin no' /etc/ssh/sshd_config"

# Check 2: Password authentication
check_security "SSH Password Auth Disabled" "grep -q '^PasswordAuthentication no' /etc/ssh/sshd_config"

# Check 3: Firewall status
check_security "Firewall Active" "ufw status | grep -q 'Status: active'"

# Check 4: Fail2ban status
check_security "Fail2ban Active" "systemctl is-active fail2ban | grep -q 'active'"

# Check 5: Audit daemon
check_security "Audit Daemon Active" "systemctl is-active auditd | grep -q 'active'"

# Check 6: File permissions
check_security "Shadow File Permissions" "test $(stat -c %a /etc/shadow) = 640"

# Check 7: SUID files
check_security "SUID Files Check" "find / -perm -4000 -type f 2>/dev/null | wc -l | grep -q '^[0-9]*$'"

# Check 8: World writable files
check_security "World Writable Files" "find / -perm -002 -type f 2>/dev/null | wc -l | grep -q '^[0-9]*$'"

# Check 9: Open ports
check_security "Open Ports Check" "netstat -tuln | wc -l | grep -q '^[0-9]*$'"

# Check 10: System updates
check_security "System Updates Available" "apt list --upgradable 2>/dev/null | wc -l | grep -q '^[0-9]*$'"

echo "=== Security Check Complete ==="
log_message "Security check completed"

# Generate summary
TOTAL_CHECKS=10
PASSED_CHECKS=$(grep "PASS" "$LOG_FILE" | tail -n 10 | wc -l)
FAILED_CHECKS=$((TOTAL_CHECKS - PASSED_CHECKS))

echo "Summary: $PASSED_CHECKS passed, $FAILED_CHECKS failed out of $TOTAL_CHECKS checks"
log_message "Summary: $PASSED_CHECKS passed, $FAILED_CHECKS failed out of $TOTAL_CHECKS checks"

# Alert if critical checks fail
if [ $FAILED_CHECKS -gt 3 ]; then
    echo -e "${RED}WARNING: Multiple security checks failed!${NC}"
    log_message "WARNING: Multiple security checks failed!"
fi
